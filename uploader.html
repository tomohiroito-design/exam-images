<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>画像アップローダー（管理）</title>
  <link rel="stylesheet" href="./assets/style.css" />
  <style>
    .panel{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row>*{flex:1;min-width:220px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .list{display:grid;gap:10px;margin-top:12px}

    .item{display:flex;gap:12px;align-items:center;background:rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.08);padding:10px;border-radius:14px;overflow:hidden}
    .item img{width:84px;height:56px;object-fit:cover;border-radius:10px;border:1px solid rgba(255,255,255,.12);flex:0 0 auto}
    .thumbPh{width:84px;height:56px;border-radius:10px;border:1px solid rgba(255,255,255,.12);display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.04);color:rgba(255,255,255,.65);font-size:11px;flex:0 0 auto}

    .grow{flex:1 1 auto;min-width:0;overflow:hidden}
    .line-ell{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .small2{opacity:.85;font-size:12px}
    .danger{border:1px solid rgba(255,0,0,.25)}
    input[type="text"]{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.22);color:inherit;outline:none}

    .actions{flex:0 0 auto;display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;align-items:center}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>画像アップローダー（管理）</h1>
      <div class="sub">入室（テンキー認証）後に操作できます</div>
      <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
        <a class="primary" style="text-decoration:none; display:inline-flex; align-items:center; justify-content:center; padding:10px 14px; border-radius:12px;"
           href="./">← ホームへ</a>
        <button id="logout" type="button">退出（トークン削除）</button>
      </div>
      <div id="toast" class="toast" style="display:none;"></div>
    </div>
  </header>

  <main class="wrap">
    <section class="panel" id="needAuth" style="display:none;">
      <h2 style="margin:0 0 10px;">入室が必要です</h2>
      <div class="small2">ホーム画面の「格納庫（管理ページ）」からテンキーで入室してください。</div>
      <div style="margin-top:10px;">
        <a class="primary" style="text-decoration:none; display:inline-flex; align-items:center; justify-content:center; padding:10px 14px; border-radius:12px;"
           href="./">入室画面へ戻る</a>
      </div>
    </section>

    <section class="panel" id="mainUi">
      <h2 style="margin:0 0 10px;">アップロード</h2>
      <div class="row">
        <input id="title" type="text" placeholder="タイトル（任意）※空ならファイル名から生成" />
        <input id="category" type="text" placeholder="カテゴリ（任意）例: 指輪" />
        <input id="tags" type="text" placeholder="タグ（任意）例: K18,ダイヤ" />
      </div>
      <div class="row" style="margin-top:10px;">
        <input id="file" type="file" multiple accept="image/*" />
        <button id="upload" class="primary" type="button">アップロード</button>
      </div>
      <div class="small2" style="margin-top:8px;opacity:.85;">
        ※アップロード前に画像を自動で軽量化（最大1600px / JPEG品質0.85）
      </div>
      <div id="result" class="list"></div>
    </section>

    <section class="panel" style="margin-top:14px;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
        <h2 style="margin:0;">削除（一覧）</h2>
        <button id="reload" type="button">一覧更新</button>
      </div>
      <div id="list" class="list"></div>
    </section>
  </main>

<script>
const WORKER = "https://exam-image-uploader.tomohiro-ito.workers.dev";
const TOKEN_KEY = "ADMIN_TOKEN";
const $ = (id) => document.getElementById(id);

function toast(msg) {
  const el = $("toast");
  el.textContent = msg;
  el.style.display = "block";
  clearTimeout(window.__t);
  window.__t = setTimeout(() => (el.style.display = "none"), 1800);
}

function getToken() {
  try { return localStorage.getItem(TOKEN_KEY) || ""; } catch { return ""; }
}

async function safeReadJson(res) {
  const text = await res.text();
  try { return JSON.parse(text); }
  catch { return { ok:false, error:"Response is not JSON", raw:text, status: res.status }; }
}

async function api(path, body) {
  const token = getToken();
  if (!token) throw new Error("Not authenticated (missing token)");

  const res = await fetch(WORKER + path, {
    method: "POST",
    headers: { "Content-Type": "application/json", "X-Admin-Token": token },
    body: JSON.stringify(body),
  });

  const data = await safeReadJson(res);
  if (!res.ok || data.ok === false) {
    throw new Error((data && (data.error || data.message)) ? (data.error || data.message) : `HTTP ${res.status}`);
  }
  return data;
}

// CDNキャッシュ回避
async function loadList() {
  const res = await fetch(`./images.json?t=${Date.now()}`, { cache: "no-store" });
  const data = await safeReadJson(res);
  if (!res.ok) return [];
  return Array.isArray(data) ? data : [];
}

function escapeHtml(s) {
  return String(s)
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeJs(s) {
  return String(s).replaceAll("\\","\\\\").replaceAll("'","\\'");
}

function onThumbError(imgEl) {
  const ph = document.createElement("div");
  ph.className = "thumbPh";
  ph.textContent = "NO IMAGE";
  imgEl.replaceWith(ph);
}

// ★日本語ファイル名でも “化けないタイトル” を作る（危ない文字だけ落とす）
function safeTitleFromFilename(name) {
  const base = String(name || "").replace(/\.[a-zA-Z0-9]+$/, "");
  // 制御文字・変な不可視を除去
  const cleaned = base.replace(/[\u0000-\u001f\u007f]/g, "").trim();
  // もし「Ã」系（既に壊れてる）なら、無理に直さず無難に置換
  if (/[ÃÂâ€]/.test(cleaned) || cleaned.length === 0) return "image";
  return cleaned;
}

// ★軽量化：画像を最大1600pxに縮小してJPEG化（PNGでも基本JPEGに）
async function compressImageToDataUrl(file, { maxSize = 1600, quality = 0.85 } = {}) {
  const type = file.type || "";
  // GIFは壊しやすいのでそのまま
  if (type.includes("gif")) return await fileToDataURL(file);

  const img = await loadImage(file);
  const { w, h } = fitSize(img.width, img.height, maxSize);

  const canvas = document.createElement("canvas");
  canvas.width = w;
  canvas.height = h;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(img, 0, 0, w, h);

  // JPEGで圧縮（背景が透明だと黒になる可能性はあるけど、試験用なら許容）
  const dataUrl = canvas.toDataURL("image/jpeg", quality);
  return dataUrl;
}

function fitSize(w, h, maxSize) {
  if (w <= maxSize && h <= maxSize) return { w, h };
  const r = Math.min(maxSize / w, maxSize / h);
  return { w: Math.round(w * r), h: Math.round(h * r) };
}

function fileToDataURL(file) {
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

function loadImage(file) {
  return new Promise(async (resolve, reject) => {
    const url = URL.createObjectURL(file);
    const img = new Image();
    img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
    img.onerror = (e) => { URL.revokeObjectURL(url); reject(e); };
    img.src = url;
  });
}

function renderItems(items) {
  $("list").innerHTML = items.map((x, idx) => {
    const filename = x.filename || "";
    const path = x.path || ("images/" + filename);
    const url  = x.url  || ("./" + path);
    const label = x.title || filename || x.path || "(unknown)";
    const imgId = "thumb_" + idx;

    return `
      <div class="item">
        <img id="${imgId}" src="${escapeHtml(url)}" alt="">
        <div class="grow">
          <div class="line-ell"><b>${escapeHtml(label)}</b></div>
          <div class="small2 mono line-ell">${escapeHtml(path)}</div>
          <div class="small2 mono line-ell">${escapeHtml(url)}</div>
          <div class="small2 line-ell">カテゴリ: ${escapeHtml(x.category || "未分類")} / タグ: ${(x.tags||[]).map(escapeHtml).join(", ")}</div>
        </div>
        <div class="actions">
          <button type="button" onclick="copyText('${escapeJs(url)}')">URLコピー</button>
          <button class="primary" type="button"
            onclick="doDelete('${escapeJs(path)}','${escapeJs(filename)}','${escapeJs(url)}')">削除</button>
        </div>
      </div>
    `;
  }).join("") || `<div class="small" style="opacity:.8;">まだ何もありません</div>`;

  items.forEach((_, idx) => {
    const el = document.getElementById("thumb_" + idx);
    if (el) el.addEventListener("error", () => onThumbError(el));
  });
}

async function refresh() {
  const items = await loadList();
  renderItems(items);
}

// ★並列数を絞った実行（2本）
async function runWithLimit(tasks, limit = 2) {
  const results = [];
  let i = 0;
  const workers = new Array(limit).fill(0).map(async () => {
    while (i < tasks.length) {
      const my = i++;
      results[my] = await tasks[my]();
    }
  });
  await Promise.all(workers);
  return results;
}

async function doUpload() {
  const files = $("file").files;
  if (!files || !files.length) { toast("ファイルを選んでね"); return; }

  const category = $("category").value.trim();
  const tags = $("tags").value.trim();
  const titleInput = $("title").value.trim();

  $("result").innerHTML = "";
  $("upload").disabled = true;

  try {
    const fileArr = Array.from(files);

    const tasks = fileArr.map((file) => async () => {
      // ★軽量化して送信（速くなる）
      const base64 = await compressImageToDataUrl(file, { maxSize: 1600, quality: 0.85 });

      // ★タイトルは入力優先、無ければ安全生成
      const title = titleInput || safeTitleFromFilename(file.name);

      const out = await api("/upload", {
        filename: file.name,
        base64,
        category,
        tags,
        title
      });

      // 成功カードは base64 で即サムネ（Pages反映待ちでも必ず出る）
      const openUrl = out.url + `?t=${Date.now()}`;

      $("result").insertAdjacentHTML("beforeend", `
        <div class="item">
          <img src="${escapeHtml(base64)}" alt="">
          <div class="grow">
            <div class="line-ell"><b>アップロード完了</b>：${escapeHtml(file.name)}</div>
            <div class="small2 mono line-ell">${escapeHtml(out.url)}</div>
          </div>
          <div class="actions">
            <button type="button" onclick="copyText('${escapeJs(out.url)}')">URLコピー</button>
            <a class="primary" style="text-decoration:none; display:inline-flex; align-items:center; justify-content:center; padding:10px 14px; border-radius:12px;"
               href="${escapeHtml(openUrl)}" target="_blank" rel="noopener">開く</a>
          </div>
        </div>
      `);

      return out;
    });

    await runWithLimit(tasks, 2);
    await refresh();
    toast("完了");
  } catch (e) {
    alert(e.message || String(e));
  } finally {
    $("upload").disabled = false;
    $("file").value = "";
  }
}

async function doDelete(path, filename, url) {
  if (!confirm(`削除する？\n${path}\n\n※実ファイルが無くても一覧(images.json)から消せます`)) return;
  try {
    const out = await api("/delete", { path, filename, url });
    toast(`削除OK（index:${out.removedFromIndex} / 正規化:${out.normalized}）`);
    await refresh();
  } catch (e) {
    alert(e.message || String(e));
  }
}

async function copyText(text) {
  await navigator.clipboard.writeText(text);
  toast("コピーしました");
}

window.doDelete = doDelete;
window.copyText = copyText;

window.addEventListener("DOMContentLoaded", async () => {
  const token = getToken();
  if (!token) {
    $("needAuth").style.display = "block";
    $("mainUi").style.display = "none";
  } else {
    $("needAuth").style.display = "none";
    $("mainUi").style.display = "block";
  }

  $("logout").addEventListener("click", () => {
    try { localStorage.removeItem(TOKEN_KEY); } catch {}
    toast("退出しました");
    setTimeout(() => location.href = "./", 500);
  });

  $("upload").addEventListener("click", doUpload);
  $("reload").addEventListener("click", () => refresh().then(() => toast("更新しました")));
  await refresh();
});
</script>
</body>
</html>
