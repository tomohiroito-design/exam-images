<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>画像アップローダー</title>
  <link rel="stylesheet" href="./assets/style.css" />
  <style>
    .panel { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; padding: 14px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row > * { flex: 1; min-width: 220px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .list { display:grid; gap:10px; margin-top:12px; }
    .item { display:flex; gap:12px; align-items:center; background: rgba(0,0,0,0.18); border:1px solid rgba(255,255,255,0.08); padding:10px; border-radius: 14px; }
    .item img { width:84px; height:56px; object-fit:cover; border-radius:10px; border:1px solid rgba(255,255,255,0.12); }
    .grow { flex: 1; min-width: 0; }
    .small2 { opacity:.8; font-size:12px; word-break:break-all; }
    .danger { border:1px solid rgba(255,0,0,.25); }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>画像アップローダー</h1>
      <div class="sub">合言葉がある人だけアップロード/削除できます（sessionStorageに保存）</div>

      <div style="margin-top:10px; display:flex; gap:10px;">
        <a class="primary" style="text-decoration:none; display:inline-flex; align-items:center; justify-content:center; padding:10px 14px; border-radius:12px;"
           href="./">← 画像格納庫へ戻る</a>
        <button id="setKey">合言葉を変更</button>
      </div>

      <div id="toast" class="toast"></div>
    </div>
  </header>

  <main class="wrap">
    <div class="panel">
      <h2 style="margin-bottom:10px;">アップロード</h2>

      <div class="row">
        <div>
          <div class="small">ファイル</div>
          <input id="file" type="file" accept="image/*" multiple />
        </div>
        <div>
          <div class="small">カテゴリ</div>
          <input id="category" placeholder="例）未分類 / ブランド / 接客 など" />
        </div>
        <div>
          <div class="small">タグ（カンマ区切り）</div>
          <input id="tags" placeholder="例）時計,ロレックス,文字盤" />
        </div>
        <div>
          <div class="small">タイトル（空ならファイル名）</div>
          <input id="title" placeholder="例）ロレックスの文字盤（例）" />
        </div>
      </div>

      <div style="margin-top:10px; display:flex; gap:10px;">
        <button id="upload" class="primary">選択した画像をアップロード</button>
        <button id="reload">一覧を再読み込み</button>
      </div>

      <div id="result" class="list"></div>
    </div>

    <div class="panel" style="margin-top:14px;">
      <h2 style="margin-bottom:10px;">削除（画像格納庫の一覧）</h2>
      <div class="small">※削除すると images/ から消え、images.json からも消します</div>
      <div id="list" class="list"></div>
    </div>
  </main>

<script>
const WORKER = "https://exam-image-uploader.tomohiro-ito.workers.dev";
const KEY_NAME = "ADMIN_KEY";

const $ = (id) => document.getElementById(id);

function toast(msg) {
  const el = $("toast");
  el.textContent = msg;
  el.style.display = "block";
  clearTimeout(window.__t);
  window.__t = setTimeout(() => (el.style.display = "none"), 1400);
}

function getKey() {
  return sessionStorage.getItem(KEY_NAME) || "";
}

async function askKey(force=false) {
  if (!force && getKey()) return;
  const k = prompt("合言葉を入力（このタブの間だけ保存）");
  if (!k) { toast("合言葉が必要です"); return; }
  sessionStorage.setItem(KEY_NAME, k);
  toast("合言葉を保存しました");
}

async function toBase64DataUrl(file) {
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

async function api(path, body) {
  const res = await fetch(WORKER + path, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-Admin-Key": getKey(),
    },
    body: JSON.stringify(body),
  });
  const text = await res.text();
  let json = null;
  try { json = JSON.parse(text); } catch {}
  if (!res.ok) {
    const msg = (json && (json.message || json.error)) ? (json.message || json.error) : text;
    throw new Error(`HTTP ${res.status}: ${msg}`);
  }
  return json || {};
}

async function loadList() {
  // GitHub Pages側の images.json を読む（格納庫と同じ）
  const res = await fetch("./images.json", { cache: "no-store" });
  const data = await res.json().catch(() => []);
  return Array.isArray(data) ? data : [];
}

function renderItems(items) {
  $("list").innerHTML = items.map(x => {
    const url = x.url || ("./" + (x.path || ("images/" + x.filename)));
    const name = x.filename || x.path || "(unknown)";
    return `
      <div class="item danger">
        <img src="${url}" alt="">
        <div class="grow">
          <div><b>${escapeHtml(name)}</b></div>
          <div class="small2 mono">${escapeHtml(url)}</div>
          <div class="small2">カテゴリ: ${escapeHtml(x.category || "未分類")} / タグ: ${(x.tags||[]).map(escapeHtml).join(", ")}</div>
        </div>
        <div style="display:flex; gap:10px;">
          <button onclick="copyText('${escapeJs(url)}')">URLコピー</button>
          <button class="primary" onclick="doDelete('${escapeJs(name)}')">削除</button>
        </div>
      </div>
    `;
  }).join("") || `<div class="small" style="opacity:.8;">まだ何もありません</div>`;
}

async function refresh() {
  const items = await loadList();
  renderItems(items);
}

async function doUpload() {
  await askKey(false);

  const files = $("file").files;
  if (!files || !files.length) { toast("ファイルを選んでね"); return; }

  const category = $("category").value.trim();
  const tags = $("tags").value.trim();
  const title = $("title").value.trim();

  $("result").innerHTML = "";

  for (const file of files) {
    const base64 = await toBase64DataUrl(file);
    try {
      const out = await api("/upload", {
        filename: file.name,
        base64,
        category,
        tags,
        title: title || file.name
      });

      $("result").insertAdjacentHTML("beforeend", `
        <div class="item">
          <img src="${out.url}" alt="">
          <div class="grow">
            <div><b>アップロード完了</b>：${escapeHtml(file.name)}</div>
            <div class="small2 mono">${escapeHtml(out.url)}</div>
          </div>
          <div style="display:flex; gap:10px;">
            <button onclick="copyText('${escapeJs(out.url)}')">URLコピー</button>
            <a class="primary" style="text-decoration:none; display:inline-flex; align-items:center; justify-content:center; padding:10px 14px; border-radius:12px;" href="${out.url}" target="_blank">開く</a>
          </div>
        </div>
      `);

    } catch (e) {
      $("result").insertAdjacentHTML("beforeend", `
        <div class="item danger">
          <div class="grow">
            <div><b>失敗</b>：${escapeHtml(file.name)}</div>
            <div class="small2 mono">${escapeHtml(e.message)}</div>
          </div>
        </div>
      `);
    }
  }

  await refresh();
  toast("完了");
}

async function doDelete(name) {
  await askKey(false);
  if (!confirm(`削除する？\n${name}`)) return;

  try {
    await api("/delete", { filename: name });
    toast("削除しました");
    await refresh();
  } catch (e) {
    alert(e.message);
  }
}

async function copyText(text) {
  await navigator.clipboard.writeText(text);
  toast("コピーしました");
}

function escapeHtml(s) {
  return String(s)
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeJs(s) { return String(s).replaceAll("\\","\\\\").replaceAll("'","\\'"); }

window.doDelete = doDelete;
window.copyText = copyText;

window.addEventListener("DOMContentLoaded", async () => {
  await askKey(false);
  $("setKey").addEventListener("click", () => askKey(true));
  $("upload").addEventListener("click", doUpload);
  $("reload").addEventListener("click", () => refresh().then(() => toast("更新しました")));
  await refresh();
});
</script>
</body>
</html>
