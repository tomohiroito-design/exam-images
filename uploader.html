<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>画像アップローダー</title>
  <link rel="stylesheet" href="./assets/style.css" />
  <style>
    .panel { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; padding: 14px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row > * { flex: 1; min-width: 220px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .list { display:grid; gap:10px; margin-top:12px; }
    .item { display:flex; gap:12px; align-items:center; background: rgba(0,0,0,0.18); border:1px solid rgba(255,255,255,0.08); padding:10px; border-radius: 14px; }
    .item img { width:84px; height:56px; object-fit:cover; border-radius:10px; border:1px solid rgba(255,255,255,0.12); }
    .grow { flex: 1; min-width: 0; }
    .small2 { opacity:.8; font-size:12px; word-break:break-all; }
    .danger { border:1px solid rgba(255,0,0,.25); }
    input[type="password"], input[type="text"]{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.22);
      color: inherit;
      outline: none;
    }
    .keyState { opacity:.85; font-size: 12px; }
    .btnRow { display:flex; gap:10px; flex-wrap:wrap; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>画像アップローダー</h1>
      <div class="sub">合言葉がある人だけアップロード/削除できます（sessionStorageに保存）</div>

      <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
        <a class="primary" style="text-decoration:none; display:inline-flex; align-items:center; justify-content:center; padding:10px 14px; border-radius:12px;"
           href="./">← 画像格納庫へ戻る</a>
      </div>

      <div id="toast" class="toast" style="display:none;"></div>
    </div>
  </header>

  <main class="wrap">
    <section class="panel">
      <h2 style="margin:0 0 10px;">合言葉</h2>
      <div class="row">
        <div>
          <input id="keyInput" type="password" placeholder="合言葉を入力して保存" autocomplete="current-password" />
          <div id="keyState" class="keyState"></div>
        </div>
        <div class="btnRow">
          <button id="saveKey" class="primary" type="button">保存</button>
          <button id="clearKey" type="button">消す</button>
        </div>
      </div>
    </section>

    <section class="panel" style="margin-top:14px;">
      <h2 style="margin:0 0 10px;">アップロード</h2>
      <div class="row">
        <input id="title" type="text" placeholder="タイトル（任意）" />
        <input id="category" type="text" placeholder="カテゴリ（任意）例: 指輪" />
        <input id="tags" type="text" placeholder="タグ（任意）例: K18,ダイヤ" />
      </div>
      <div class="row" style="margin-top:10px;">
        <input id="file" type="file" multiple accept="image/*" />
        <button id="upload" class="primary" type="button">アップロード</button>
      </div>
      <div id="result" class="list"></div>
    </section>

    <section class="panel" style="margin-top:14px;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;">
        <h2 style="margin:0;">削除（一覧）</h2>
        <button id="reload" type="button">一覧更新</button>
      </div>
      <div id="list" class="list"></div>
    </section>
  </main>

<script>
const WORKER = "https://exam-image-uploader.tomohiro-ito.workers.dev";
const KEY_NAME = "ADMIN_KEY";
const $ = (id) => document.getElementById(id);

function toast(msg) {
  const el = $("toast");
  el.textContent = msg;
  el.style.display = "block";
  clearTimeout(window.__t);
  window.__t = setTimeout(() => (el.style.display = "none"), 1600);
}

function getKey() {
  return sessionStorage.getItem(KEY_NAME) || "";
}

function setKeyState() {
  $("keyState").textContent = getKey()
    ? "保存済み（このタブを閉じるまで有効）"
    : "未設定（保存してから操作できます）";
}

async function toBase64DataUrl(file) {
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

async function api(path, body) {
  const key = getKey();
  if (!key) throw new Error("合言葉が未設定です（上で保存してください）");

  const res = await fetch(WORKER + path, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-Admin-Key": key,
    },
    body: JSON.stringify(body),
  });

  const text = await res.text();
  let json = null;
  try { json = JSON.parse(text); } catch {}

  if (!res.ok) {
    const msg = (json && (json.error || json.message)) ? (json.error || json.message) : text;
    throw new Error(`HTTP ${res.status}: ${msg}`);
  }
  if (json && json.ok === false) {
    throw new Error(json.error || "Unknown error");
  }
  return json || {};
}

async function loadList() {
  const res = await fetch("./images.json", { cache: "no-store" });
  const data = await res.json().catch(() => []);
  return Array.isArray(data) ? data : [];
}

function renderItems(items) {
  $("list").innerHTML = items.map(x => {
    const path = x.path || ("images/" + (x.filename || ""));
    const url = x.url || ("./" + path);
    const label = x.title || x.filename || x.path || "(unknown)";
    return `
      <div class="item">
        <img src="${escapeHtml(url)}" alt="">
        <div class="grow">
          <div><b>${escapeHtml(label)}</b></div>
          <div class="small2 mono">${escapeHtml(path)}</div>
          <div class="small2 mono">${escapeHtml(url)}</div>
          <div class="small2">カテゴリ: ${escapeHtml(x.category || "未分類")} / タグ: ${(x.tags||[]).map(escapeHtml).join(", ")}</div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button type="button" onclick="copyText('${escapeJs(url)}')">URLコピー</button>
          <button class="primary" type="button" onclick="doDelete('${escapeJs(path)}')">削除</button>
        </div>
      </div>
    `;
  }).join("") || `<div class="small" style="opacity:.8;">まだ何もありません</div>`;
}

async function refresh() {
  const items = await loadList();
  renderItems(items);
}

async function doUpload() {
  const files = $("file").files;
  if (!files || !files.length) { toast("ファイルを選んでね"); return; }

  const category = $("category").value.trim();
  const tags = $("tags").value.trim();
  const title = $("title").value.trim();

  $("result").innerHTML = "";

  $("upload").disabled = true;

  try {
    for (const file of files) {
      const base64 = await toBase64DataUrl(file);
      try {
        const out = await api("/upload", {
          filename: file.name,
          base64,
          category,
          tags,
          title: title || file.name
        });

        $("result").insertAdjacentHTML("beforeend", `
          <div class="item">
            <img src="${escapeHtml(out.url)}" alt="">
            <div class="grow">
              <div><b>アップロード完了</b>：${escapeHtml(file.name)}</div>
              <div class="small2 mono">${escapeHtml(out.url)}</div>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button type="button" onclick="copyText('${escapeJs(out.url)}')">URLコピー</button>
              <a class="primary" style="text-decoration:none; display:inline-flex; align-items:center; justify-content:center; padding:10px 14px; border-radius:12px;"
                 href="${escapeHtml(out.url)}" target="_blank" rel="noopener">開く</a>
            </div>
          </div>
        `);

      } catch (e) {
        $("result").insertAdjacentHTML("beforeend", `
          <div class="item danger">
            <div class="grow">
              <div><b>失敗</b>：${escapeHtml(file.name)}</div>
              <div class="small2 mono">${escapeHtml(e.message)}</div>
            </div>
          </div>
        `);
      }
    }

    await refresh();
    toast("完了");
  } finally {
    $("upload").disabled = false;
    $("file").value = "";
  }
}

async function doDelete(pathOrName) {
  if (!getKey()) { toast("合言葉が未設定です"); return; }

  if (!confirm(`削除する？\n${pathOrName}`)) return;

  try {
    await api("/delete", { filename: pathOrName }); // Worker側が path もOK
    toast("削除しました");
    await refresh();
  } catch (e) {
    alert(e.message);
  }
}

async function copyText(text) {
  await navigator.clipboard.writeText(text);
  toast("コピーしました");
}

function escapeHtml(s) {
  return String(s)
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeJs(s) {
  return String(s).replaceAll("\\","\\\\").replaceAll("'","\\'");
}

window.doDelete = doDelete;
window.copyText = copyText;

window.addEventListener("DOMContentLoaded", async () => {
  setKeyState();

  $("saveKey").addEventListener("click", () => {
    const v = ($("keyInput").value || "").trim();
    if (!v) { toast("合言葉が空です"); return; }
    sessionStorage.setItem(KEY_NAME, v);
    $("keyInput").value = "";
    setKeyState();
    toast("合言葉を保存しました");
  });

  $("clearKey").addEventListener("click", () => {
    sessionStorage.removeItem(KEY_NAME);
    setKeyState();
    toast("合言葉を消しました");
  });

  $("upload").addEventListener("click", doUpload);
  $("reload").addEventListener("click", () => refresh().then(() => toast("更新しました")));

  await refresh();
});
</script>
</body>
</html>
